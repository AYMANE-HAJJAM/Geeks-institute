{% extends "base.html" %}

{% block content %}
<div class="flex flex-col gap-6">

    <!-- Welcome Card -->
    <div class="bg-white rounded-xl shadow-md p-6 text-center">
        <h2 class="text-2xl font-bold text-blue-700 mb-2">Welcome, {{ user_name }}!</h2>
        <p class="text-gray-700">Logged in as <span class="font-semibold text-blue-600">{{ user_role|capitalize }}</span>.</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        <div class="bg-blue-100 text-blue-800 p-4 rounded text-center font-bold">
            Total Vehicles: <span id="totalVehicles">0</span>
        </div>
        <div class="bg-green-100 text-green-800 p-4 rounded text-center font-bold">
            Available: <span id="availableVehicles">0</span>
        </div>
        <div class="bg-red-100 text-red-800 p-4 rounded text-center font-bold">
            Sold: <span id="soldVehicles">0</span>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded shadow">
            <h3 class="text-lg font-semibold mb-2">Vehicles by Status</h3>
            <canvas id="statusChart"></canvas>
        </div>
        <div class="bg-white p-6 rounded shadow">
            <h3 class="text-lg font-semibold mb-2">Vehicles by Year</h3>
            <canvas id="yearChart"></canvas>
        </div>
    </div>

    <!-- Vehicle Table -->
    <div class="bg-white p-6 rounded shadow overflow-x-auto">
        <table class="min-w-full text-left border border-gray-200 rounded">
            <thead class="bg-gray-50">
                <tr>
                    <th class="py-2 px-4">Name</th>
                    <th class="py-2 px-4">Model</th>
                    <th class="py-2 px-4">Price</th>
                    <th class="py-2 px-4">Year</th>
                    <th class="py-2 px-4">Status</th>
                    {% if user_role == 'salesperson' %}<th class="py-2 px-4">Actions</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for vehicle in vehicles %}
                <tr class="border-b">
                    <td class="py-2 px-4">{{ vehicle.name }}</td>
                    <td class="py-2 px-4">{{ vehicle.model }}</td>
                    <td class="py-2 px-4">${{ vehicle.price }}</td>
                    <td class="py-2 px-4">{{ vehicle.year }}</td>
                    <td class="py-2 px-4">{{ vehicle.status }}</td>
                    {% if user_role == 'salesperson' %}
                    <td class="py-2 px-4">
                        <a href="/vehicles/{{ vehicle.id }}/edit" class="text-blue-600 hover:underline mr-2">Edit</a>
                        <form action="/vehicles/{{ vehicle.id }}/delete" method="POST" class="inline">
                            <button type="submit" class="text-red-600 hover:underline ml-2" onclick="return confirm('Are you sure?');">Delete</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
fetch('/dashboard/stats')
.then(res => res.json())
.then(data => {
    const total = data.vehicle_status.reduce((a,b)=>a+b.count,0);
    const available = data.vehicle_status.find(v=>v.status==='Available')?.count||0;
    const sold = data.vehicle_status.find(v=>v.status==='Sold')?.count||0;

    document.getElementById('totalVehicles').textContent = total;
    document.getElementById('availableVehicles').textContent = available;
    document.getElementById('soldVehicles').textContent = sold;

    new Chart(document.getElementById('statusChart').getContext('2d'),{
        type:'doughnut',
        data:{labels:data.vehicle_status.map(v=>v.status), datasets:[{data:data.vehicle_status.map(v=>v.count), backgroundColor:['#3B82F6','#EF4444']}]},
        options:{responsive:true, plugins:{legend:{position:'bottom'}}}
    });

    new Chart(document.getElementById('yearChart').getContext('2d'),{
        type:'bar',
        data:{labels:data.vehicle_years.map(v=>v.year), datasets:[{label:'Vehicles by Year', data:data.vehicle_years.map(v=>v.count), backgroundColor:'#10B981'}]},
        options:{responsive:true}
    });
});
</script>
{% endblock %}
